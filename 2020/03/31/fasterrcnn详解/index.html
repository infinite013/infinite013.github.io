<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="fasterrcnn详解"><meta name="keywords" content="cv,fasterrcnn"><meta name="author" content="lulu"><meta name="copyright" content="lulu"><title>fasterrcnn详解 | LULU</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#fasterrcnn结构概览"><span class="toc-number">1.</span> <span class="toc-text">fasterrcnn结构概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RPN-Region-Proposal-Networks-到底是什么"><span class="toc-number">2.</span> <span class="toc-text">RPN(Region Proposal Networks)到底是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#anchor"><span class="toc-number">2.1.</span> <span class="toc-text">anchor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bounding-box-regression"><span class="toc-number">2.2.</span> <span class="toc-text">bounding box regression</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模型训练中的损失函数"><span class="toc-number">3.</span> <span class="toc-text">模型训练中的损失函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">lulu</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/infinite013" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">2</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">3</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">2</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2020/03/26/S1c2LebyfiZVFBx.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">LULU</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/about">关于作者</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">fasterrcnn详解</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-31</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/cv/">cv</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">1.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 4 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="fasterrcnn结构概览"><a href="#fasterrcnn结构概览" class="headerlink" title="fasterrcnn结构概览"></a>fasterrcnn结构概览</h2><p><img src="https://i.loli.net/2020/03/31/3joDRnFCWf2zdks.png" alt="Faster RCNN结构图"><br>    上图为论文中的总体结构，在作者看来，主要分为四个部分：</p>
<ol>
<li><p>Conv layers。作为一种CNN网络目标检测方法，Faster RCNN首先使用一组基础的conv+relu+pooling层提取image的feature maps。该feature maps被共享用于后续RPN层和全连接层。</p>
</li>
<li><p>Region Proposal Networks。RPN网络用于生成region proposals。该层通过softmax判断anchors属于positive或者negative，再利用bounding box regression修正anchors获得精确的proposals。</p>
</li>
<li><p>Roi Pooling。该层收集输入的feature maps和proposals，综合这些信息后提取proposal feature maps，送入后续全连接层判定目标类别。</p>
</li>
<li><p>Classification。利用proposal feature maps计算proposal的类别，同时再次bounding box regression获得检测框最终的精确位置。</p>
<p> 另一种结构图如下所示：<img src="https://i.loli.net/2020/03/31/eWSPnOvXcVEN3tu.png" alt="框架"><br> 表示为python版本中的VGG16模型中的faster_rcnn_test.pt的网络结构，可以清晰的看到该网络对于一副任意大小PxQ的图像，首先缩放至固定大小MxN，然后将MxN图像送入网络；而Conv layers中包含了13个conv层+13个relu层+4个pooling层；RPN网络首先经过3x3卷积，再分别生成positive anchors和对应bounding box regression偏移量，然后计算出proposals；而Roi Pooling层则利用proposals从feature maps中提取proposal feature送入后续全连接和softmax网络作classification（即分类proposal到底是什么object）。</p>
</li>
</ol>
<h2 id="RPN-Region-Proposal-Networks-到底是什么"><a href="#RPN-Region-Proposal-Networks-到底是什么" class="headerlink" title="RPN(Region Proposal Networks)到底是什么"></a>RPN(Region Proposal Networks)到底是什么</h2><p>   到底什么是RPN呢，他又起了什么作用呢？我们首先来看RPN的网络结构<img src="https://i.loli.net/2020/03/31/DuUgAoyveBfVlSq.png" alt="RPN结构"><br>    具体来说，我们可以将它分解为两条路径，上方的一条路径通过softmax对anchor进行一个<strong>二分类</strong>，区分positive和negative的anchor，下方路径计算anchor对于bbx的偏移量，获得精确的proposal，<strong>最后的Proposal层则负责综合positive anchors和对应bounding box regression偏移量获取proposals，同时剔除太小和超出边界的proposals。其实整个网络到了Proposal Layer这里，就完成了相当于目标定位的功能</strong>。<br>    其实RPN最终就是在原图尺度上，设置了密密麻麻的候选Anchor。然后用cnn去判断哪些Anchor是里面有目标的positive anchor，哪些是没目标的negative anchor。</p>
<h3 id="anchor"><a href="#anchor" class="headerlink" title="anchor"></a>anchor</h3><p>   提到RPN，就离不开anchor。所谓anchors，实际上就是一组由rpn/generate_anchors.py生成的矩形，直接运行mmdetection中的anchor生成代码，可以得到以下输出：<br>`[[ -84.  -40. 99.  55.]</p>
<p> [-176.  -88.  191.  103.]<br> [-360. -184.  375.  199.]<br> [ -56.  -56.   71.   71.]<br> [-120. -120.  135.  135.]<br> [-248. -248.  263.  263.]<br> [ -36.  -80.   51.   95.]<br> [ -80. -168.   95.  183.]<br> [-168. -344.  183.  359.]]</p>
<p> `<br><img src="https://i.loli.net/2020/03/31/MEV2By4XP91jZxw.png" alt="anchor示意图"><br>     这就是生成的anchor，其中每行的4个值(x1,y1,x2,y2)表矩形左上和右下角点坐标。9个矩形共有3种形状，长宽比为大约为 三种，如图6。实际上通过anchors就引入了检测中常用到的多尺度方法。<br>    对于维度是(W,H)的特征图来说，其生成的anchor个数为WxHx9个，这些anchor对应这特征图上的各个部分，然后对这些anchor进行判定，判定其中是否包含正样本(即包含可能的目标)<br>    当然，在获得positive anchor后，我们要对anchor进行微调，让他更接近真实的bbx，这就称作bounding box regression。</p>
<h3 id="bounding-box-regression"><a href="#bounding-box-regression" class="headerlink" title="bounding box regression"></a>bounding box regression</h3><p>如下图所示绿色框为飞机的Ground Truth(GT)，红色为提取的positive anchors，即便红色的框被分类器识别为飞机，但是由于红色的框定位不准，这张图相当于没有正确的检测出飞机。所以我们希望采用一种方法对红色的框进行微调，使得positive anchors和GT更加接近。<br><img src="https://i.loli.net/2020/03/31/Z2yABCnGRmb6ruE.png" alt="GT与anchor对比图"><br>   对于窗口一般使用四维向量(x,y,w,h)表示，分别表示窗口的中心点坐标和宽高，对于下图，红色的框A代表原始的positive Anchors，绿色的框G代表目标的GT，我们的目标是寻找一种关系，使得输入原始的anchor A经过映射得到一个跟真实窗口G更接近的回归窗口G’，即：<br>  <img src="https://i.loli.net/2020/03/31/bMHV5RfU2Y6Nim3.png" alt=""><br>   那么经过何种变换F才能从图中的anchor A变为G’呢？ 比较简单的思路就是:<br><img src="https://i.loli.net/2020/03/31/si21RvB6QONFq4k.png" alt="变换"><br><img src="https://i.loli.net/2020/03/31/L78RpPwXVDZnlgd.png" alt=""><br><img src="https://i.loli.net/2020/03/31/6N9OJCjHFVy8mIx.png" alt=""><br><img src="https://i.loli.net/2020/03/31/iI1Pdljfm6TEkQM.png" alt=""></p>
<h2 id="模型训练中的损失函数"><a href="#模型训练中的损失函数" class="headerlink" title="模型训练中的损失函数"></a>模型训练中的损失函数</h2><p>在模型训练的过程中，如下图所示，<br>有两个Classification loss和两个Bounding-box regression loss，区别为：<br>Input Image经过CNN特征提取，首先来到Region Proposal网络。由Regio Proposal Network输出的Classification，这并不是判定物体在数据集上对应的类中哪一类，而是输出一个Binary的值p，可以理解为p在0，1之间 ，人工设定一个threshold=0.5。RPN网络做的事情就是，如果一个Region的 p&gt;=0.5，则认为这个Region中可能是80个类别中的某一类，具体是哪一类现在还不清楚。到此为止，Network只需要把这些可能含有物体的区域选取出来就可以了，这些被选取出来的Region又叫做ROI （Region of Interests），即感兴趣的区域。当然了，RPN同时也会在feature map上框定这些ROI感兴趣区域的大致位置，即Bounding-box。<br><img src="https://i.loli.net/2020/03/31/hAXHFNVTDkYv48S.png" alt="损失函数框图"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="quote">&gt; [](https://zhuanlan.zhihu.com/p/31426458)</span></span><br><span class="line"><span class="quote">&gt; [](https://zhuanlan.zhihu.com/p/69250914)</span></span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">lulu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/03/31/fasterrcnn%E8%AF%A6%E8%A7%A3/">http://yoursite.com/2020/03/31/fasterrcnn%E8%AF%A6%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">LULU</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cv/">cv</a><a class="post-meta__tags" href="/tags/fasterrcnn/">fasterrcnn</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/03/26/%E5%8D%9A%E5%AE%A2%E4%B8%8A%E4%BC%A0/"><span>博客上传</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '55314e5ef72f24b3de33',
  clientSecret: '723d03b72287558b357635339f8bc39e48f39197',
  repo: 'infinite013.github.io',
  owner: 'infinite013',
  admin: 'infinite013',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://i.loli.net/2020/03/26/S1c2LebyfiZVFBx.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 By lulu</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">如果不能按你所想的方式去活，总有一天你会按照你活的方式去想。</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>